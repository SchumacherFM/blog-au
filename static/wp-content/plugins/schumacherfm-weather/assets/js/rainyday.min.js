/*!
 * rainyday.js v0.1.3 - https://github.com/maroslaw/rainyday.js
 * Copyright (c) 2013 Marek Brodziakt
 * Licensed under the GPLv2 license
 */
function RainyDay(e){this.img=document.getElementById(e.element);this.opacity=typeof e.opacity==="undefined"?1:e.opacity;this.blurRadius=typeof e.blur==="undefined"?10:e.blur;if(typeof e.crop==="undefined"){this.crop=[0,0,this.img.clientWidth,this.img.clientHeight];this.enableSizeChange=true}else{this.crop=e.crop;this.enableSizeChange=false}this.cropX=this.crop[0];this.cropY=this.crop[1];this.imageWidth=this.crop[2];this.imageHeight=this.crop[3];this.parentElement=typeof e.parentElement==="undefined"?document.getElementsByTagName("body")[0]:e.parentElement;this.drops=[];this.canvas=this.prepareCanvas();this.prepareBackground(this.imageWidth,this.imageHeight);this.prepareGlass();this.reflection=this.REFLECTION_MINIATURE;this.trail=this.TRAIL_DROPS;this.gravity=this.GRAVITY_NON_LINEAR;this.collision=this.COLLISION_SIMPLE;this.VARIABLE_GRAVITY_THRESHOLD=3;this.VARIABLE_GRAVITY_ANGLE=Math.PI/2;this.VARIABLE_GRAVITY_ANGLE_VARIANCE=0;this.VARIABLE_FPS=e.fps;this.VARIABLE_FILL_STYLE="#8ED6FF";this.VARIABLE_COLLISIONS=true;this.REFLECTION_SCALEDOWN_FACTOR=5;this.REFLECTION_DROP_MAPPING_WIDTH=200;this.REFLECTION_DROP_MAPPING_HEIGHT=200;this.setRequestAnimFrame()}function Drop(e,t,n,r,i){this.x=Math.floor(t);this.y=Math.floor(n);this.r=Math.random()*i+r;this.rainyday=e;this.context=e.context;this.reflection=e.reflected}function BlurStack(){this.r=0;this.g=0;this.b=0;this.next=null}function CollisionMatrix(e,t,n){this.resolution=n;this.xc=e;this.yc=t;this.matrix=new Array(e);for(var r=0;r<=e+5;r++){this.matrix[r]=new Array(t);for(var i=0;i<=t+5;++i){this.matrix[r][i]=new DropItem(null)}}}function DropItem(e){this.drop=e;this.next=null}RainyDay.prototype.prepareCanvas=function(){var e=document.createElement("canvas");e.style.position="absolute";e.width=this.imageWidth;e.height=this.imageHeight;e.style.left=this.cropX+"px";e.style.top=this.cropY+"px";this.parentElement.appendChild(e);if(this.enableSizeChange){this.setResizeHandler()}return e};RainyDay.prototype.setResizeHandler=function(){if(window.onresize!==null){window.setInterval(this.checkSize.bind(this),100)}else{window.onresize=this.checkSize.bind(this)}};RainyDay.prototype.checkSize=function(){var e=false;var t=this.img.clientWidth;var n=this.img.clientHeight;var r=this.img.offsetLeft;var i=this.img.offsetTop;var s=this.canvas.width;var o=this.canvas.height;var u=this.canvas.offsetLeft;var a=this.canvas.offsetTop;if(s!==t){s=t;e=true}if(o!==n){o=n;e=true}if(u!==r){u=r;e=true}if(a!==i){a=i;e=true}if(e){this.imageWidth=this.canvas.width;this.imageHeight=this.canvas.height;this.prepareBackground(this.imageWidth,this.imageHeight);this.glass.width=this.imageWidth;this.glass.height=this.imageHeight;this.prepareReflections()}};RainyDay.prototype.animateDrops=function(){if(this.addDropCallback){this.addDropCallback()}var e=this.drops.slice();var t=[];for(var n=0;n<e.length;++n){if(e[n].animate()){t.push(e[n])}}this.drops=t;window.requestAnimFrame(this.animateDrops.bind(this))};RainyDay.prototype.setRequestAnimFrame=function(){var e=this.VARIABLE_FPS;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/e)}}()};RainyDay.prototype.prepareReflections=function(){this.reflected=document.createElement("canvas");this.reflected.width=this.canvas.width/this.REFLECTION_SCALEDOWN_FACTOR;this.reflected.height=this.canvas.height/this.REFLECTION_SCALEDOWN_FACTOR;var e=this.reflected.getContext("2d");e.drawImage(this.img,this.cropX,this.cropY,this.imageWidth,this.imageHeight,0,0,this.reflected.width,this.reflected.height)};RainyDay.prototype.prepareGlass=function(){this.glass=document.createElement("canvas");this.glass.width=this.canvas.width;this.glass.height=this.canvas.height;this.context=this.glass.getContext("2d")};RainyDay.prototype.rain=function(e,t){if(this.reflection!==this.REFLECTION_NONE){this.prepareReflections()}this.animateDrops();this.presets=e;this.PRIVATE_GRAVITY_FORCE_FACTOR_Y=this.VARIABLE_FPS*.001/25;this.PRIVATE_GRAVITY_FORCE_FACTOR_X=(Math.PI/2-this.VARIABLE_GRAVITY_ANGLE)*this.VARIABLE_FPS*.001/50;if(this.VARIABLE_COLLISIONS){var n=0;for(var r=0;r<e.length;r++){if(e[r][0]+e[r][1]>n){n=Math.floor(e[r][0]+e[r][1])}}if(n>0){var i=Math.ceil(this.imageWidth/n);var s=Math.ceil(this.imageHeight/n);this.matrix=new CollisionMatrix(i,s,n)}else{this.VARIABLE_COLLISIONS=false}}for(var r=0;r<e.length;r++){if(!e[r][3]){e[r][3]=-1}}var o=0;this.addDropCallback=function(){var n=(new Date).getTime();if(n-o<t){return}o=n;var r=this.canvas.getContext("2d");r.clearRect(0,0,this.canvas.width,this.canvas.height);r.drawImage(this.background,0,0,this.canvas.width,this.canvas.height);var i;for(var s=0;s<e.length;s++){if(e[s][2]>1||e[s][3]===-1){if(e[s][3]!==0){e[s][3]--;for(var u=0;u<e[s][2];++u){this.putDrop(new Drop(this,Math.random()*this.imageWidth,Math.random()*this.imageHeight,e[s][0],e[s][1]))}}}else if(Math.random()<e[s][2]){i=e[s];break}}if(i){this.putDrop(new Drop(this,Math.random()*this.imageWidth,Math.random()*this.imageHeight,i[0],i[1]))}r.save();r.globalAlpha=this.opacity;r.drawImage(this.glass,0,0,this.canvas.width,this.canvas.height);r.restore()}.bind(this)};RainyDay.prototype.putDrop=function(e){e.draw();if(this.gravity&&e.r>this.VARIABLE_GRAVITY_THRESHOLD){if(this.VARIABLE_COLLISIONS){this.matrix.update(e)}this.drops.push(e)}};RainyDay.prototype.clearDrop=function(e,t){var n=e.clear(t);if(n){var r=this.drops.indexOf(e);if(r>=0){this.drops.splice(r,1)}}return n};Drop.prototype.draw=function(){this.context.save();this.context.beginPath();var e=this.r;this.r=.95*this.r;if(this.r<3){this.context.arc(this.x,this.y,this.r,0,Math.PI*2,true);this.context.closePath()}else if(this.colliding||this.yspeed>2){if(this.colliding){var t=this.colliding;this.r=1.001*(this.r>t.r?this.r:t.r);this.x+=t.x-this.x;this.colliding=null}var n=1+.1*this.yspeed;this.context.moveTo(this.x-this.r/n,this.y);this.context.bezierCurveTo(this.x-this.r,this.y-this.r*2,this.x+this.r,this.y-this.r*2,this.x+this.r/n,this.y);this.context.bezierCurveTo(this.x+this.r,this.y+n*this.r,this.x-this.r,this.y+n*this.r,this.x-this.r/n,this.y)}else{this.context.arc(this.x,this.y,this.r*.9,0,Math.PI*2,true);this.context.closePath()}this.context.clip();this.r=e;if(this.rainyday.reflection){this.rainyday.reflection(this)}this.context.restore()};Drop.prototype.clear=function(e){this.context.clearRect(this.x-this.r-1,this.y-this.r-2,2*this.r+2,2*this.r+2);if(e){this.terminate=true;return true}if(this.y-this.r>this.rainyday.h||this.x-this.r>this.rainyday.w||this.x+this.r<0){return true}return false};Drop.prototype.animate=function(){if(this.terminate){return false}var e=this.rainyday.gravity(this);if(!e&&this.rainyday.trail){this.rainyday.trail(this)}if(this.rainyday.VARIABLE_COLLISIONS){var t=this.rainyday.matrix.update(this,e);if(t){this.rainyday.collision(this,t)}}return!e||this.terminate};RainyDay.prototype.TRAIL_NONE=function(){};RainyDay.prototype.TRAIL_DROPS=function(e){if(!e.trailY||e.y-e.trailY>=Math.random()*100*e.r){e.trailY=e.y;this.putDrop(new Drop(this,e.x+(Math.random()*2-1)*Math.random(),e.y-e.r-5,Math.ceil(e.r/5),0))}};RainyDay.prototype.TRAIL_SMUDGE=function(e){var t=e.y-e.r-3;var n=e.x-e.r/2+Math.random()*2;if(t<0||n<0){return}this.context.drawImage(this.clearbackground,n,t,e.r,2,n,t,e.r,2)};RainyDay.prototype.GRAVITY_NONE=function(){return true};RainyDay.prototype.GRAVITY_LINEAR=function(e){if(this.clearDrop(e)){return true}if(e.yspeed){e.yspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(e.r);e.xspeed+=this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(e.r)}else{e.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;e.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}e.y+=e.yspeed;e.draw();return false};RainyDay.prototype.GRAVITY_NON_LINEAR=function(e){if(this.clearDrop(e)){return true}if(e.collided){e.collided=false;e.seed=Math.floor(e.r*Math.random()*this.VARIABLE_FPS);e.skipping=false;e.slowing=false}else if(!e.seed||e.seed<0){e.seed=Math.floor(e.r*Math.random()*this.VARIABLE_FPS);e.skipping=e.skipping===false?true:false;e.slowing=true}e.seed--;if(e.yspeed){if(e.slowing){e.yspeed/=1.1;e.xspeed/=1.1;if(e.yspeed<this.PRIVATE_GRAVITY_FORCE_FACTOR_Y){e.slowing=false}}else if(e.skipping){e.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;e.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}else{e.yspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_Y*Math.floor(e.r);e.xspeed+=1*this.PRIVATE_GRAVITY_FORCE_FACTOR_X*Math.floor(e.r)}}else{e.yspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_Y;e.xspeed=this.PRIVATE_GRAVITY_FORCE_FACTOR_X}if(this.VARIABLE_GRAVITY_ANGLE_VARIANCE!==0){e.xspeed+=(Math.random()*2-1)*e.yspeed*this.VARIABLE_GRAVITY_ANGLE_VARIANCE}e.y+=e.yspeed;e.x+=e.xspeed;e.draw();return false};RainyDay.prototype.REFLECTION_NONE=function(){this.context.fillStyle=this.VARIABLE_FILL_STYLE;this.context.fill()};RainyDay.prototype.REFLECTION_MINIATURE=function(e){var t=Math.max((e.x-this.REFLECTION_DROP_MAPPING_WIDTH)/this.REFLECTION_SCALEDOWN_FACTOR,0);var n=Math.max((e.y-this.REFLECTION_DROP_MAPPING_HEIGHT)/this.REFLECTION_SCALEDOWN_FACTOR,0);var r=Math.min(this.REFLECTION_DROP_MAPPING_WIDTH*2/this.REFLECTION_SCALEDOWN_FACTOR,this.reflected.width-t);var i=Math.min(this.REFLECTION_DROP_MAPPING_HEIGHT*2/this.REFLECTION_SCALEDOWN_FACTOR,this.reflected.height-n);this.context.drawImage(this.reflected,t,n,r,i,e.x-1.1*e.r,e.y-1.1*e.r,e.r*2,e.r*2)};RainyDay.prototype.COLLISION_SIMPLE=function(e,t){var n=t;var r;while(n!=null){var i=n.drop;if(Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2))<e.r+i.r){r=i;break}n=n.next}if(!r){return}var s,o;if(e.y>r.y){s=e;o=r}else{s=r;o=e}this.clearDrop(o);this.clearDrop(s,true);this.matrix.remove(s);o.draw();o.colliding=s;o.collided=true};RainyDay.prototype.prepareBackground=function(){this.background=document.createElement("canvas");this.background.width=this.canvas.width;this.background.height=this.canvas.height;this.clearbackground=document.createElement("canvas");this.clearbackground.width=this.canvas.width;this.clearbackground.height=this.canvas.height;var e=this.background.getContext("2d");e.clearRect(0,0,this.imageWidth,this.imageHeight);e.drawImage(this.img,this.cropX,this.cropY,this.imageWidth,this.imageHeight,0,0,this.imageWidth,this.imageHeight);e=this.clearbackground.getContext("2d");e.clearRect(0,0,this.imageWidth,this.imageHeight);e.drawImage(this.img,this.cropX,this.cropY,this.imageWidth,this.imageHeight,0,0,this.imageWidth,this.imageHeight);if(!isNaN(this.blurRadius)&&this.blurRadius>=1){this.stackBlurCanvasRGB(this.imageWidth,this.imageHeight,this.blurRadius)}};RainyDay.prototype.stackBlurCanvasRGB=function(e,t,n){var r=[[0,9],[1,11],[2,12],[3,13],[5,14],[7,15],[11,16],[15,17],[22,18],[31,19],[45,20],[63,21],[90,22],[127,23],[181,24]];var i=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];n|=0;var s=this.background.getContext("2d");var o=s.getImageData(0,0,e,t);var u=o.data;var a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k;var L=n+1;var A=L*(L+1)/2;var O=new BlurStack;var M=new BlurStack;var _=O;for(l=1;l<2*n+1;l++){_=_.next=new BlurStack;if(l===L){M=_}}_.next=O;var D=null;var P=null;d=p=0;var H=i[n];var B;for(var j=0;j<r.length;++j){if(n<=r[j][0]){B=r[j-1][1];break}}for(f=0;f<t;f++){E=S=x=v=m=g=0;y=L*(T=u[p]);b=L*(N=u[p+1]);w=L*(C=u[p+2]);v+=A*T;m+=A*N;g+=A*C;_=O;for(l=0;l<L;l++){_.r=T;_.g=N;_.b=C;_=_.next}for(l=1;l<L;l++){c=p+((e-1<l?e-1:l)<<2);v+=(_.r=T=u[c])*(k=L-l);m+=(_.g=N=u[c+1])*k;g+=(_.b=C=u[c+2])*k;E+=T;S+=N;x+=C;_=_.next}D=O;P=M;for(a=0;a<e;a++){u[p]=v*H>>B;u[p+1]=m*H>>B;u[p+2]=g*H>>B;v-=y;m-=b;g-=w;y-=D.r;b-=D.g;w-=D.b;c=d+((c=a+n+1)<e-1?c:e-1)<<2;E+=D.r=u[c];S+=D.g=u[c+1];x+=D.b=u[c+2];v+=E;m+=S;g+=x;D=D.next;y+=T=P.r;b+=N=P.g;w+=C=P.b;E-=T;S-=N;x-=C;P=P.next;p+=4}d+=e}for(a=0;a<e;a++){S=x=E=m=g=v=0;p=a<<2;y=L*(T=u[p]);b=L*(N=u[p+1]);w=L*(C=u[p+2]);v+=A*T;m+=A*N;g+=A*C;_=O;for(l=0;l<L;l++){_.r=T;_.g=N;_.b=C;_=_.next}h=e;for(l=1;l<L;l++){p=h+a<<2;v+=(_.r=T=u[p])*(k=L-l);m+=(_.g=N=u[p+1])*k;g+=(_.b=C=u[p+2])*k;E+=T;S+=N;x+=C;_=_.next;if(l<t-1){h+=e}}p=a;D=O;P=M;for(f=0;f<t;f++){c=p<<2;u[c]=v*H>>B;u[c+1]=m*H>>B;u[c+2]=g*H>>B;v-=y;m-=b;g-=w;y-=D.r;b-=D.g;w-=D.b;c=a+((c=f+L)<t-1?c:t-1)*e<<2;v+=E+=D.r=u[c];m+=S+=D.g=u[c+1];g+=x+=D.b=u[c+2];D=D.next;y+=T=P.r;b+=N=P.g;w+=C=P.b;E-=T;S-=N;x-=C;P=P.next;p+=e}}s.putImageData(o,0,0)};CollisionMatrix.prototype.update=function(e,t){if(e.gid){this.matrix[e.gmx][e.gmy].remove(e);if(t){return null}e.gmx=Math.floor(e.x/this.resolution);e.gmy=Math.floor(e.y/this.resolution);if(!this.matrix[e.gmx]||!this.matrix[e.gmx][e.gmy]){return null}this.matrix[e.gmx][e.gmy].add(e);var n=this.collisions(e);if(n&&n.next!=null){return n.next}}else{e.gid=Math.random().toString(36).substr(2,9);e.gmx=Math.floor(e.x/this.resolution);e.gmy=Math.floor(e.y/this.resolution);if(!this.matrix[e.gmx]||!this.matrix[e.gmx][e.gmy]){return null}this.matrix[e.gmx][e.gmy].add(e)}return null};CollisionMatrix.prototype.collisions=function(e){var t=new DropItem(null);var n=t;t=this.addAll(t,e.gmx-1,e.gmy+1);t=this.addAll(t,e.gmx,e.gmy+1);t=this.addAll(t,e.gmx+1,e.gmy+1);return n};CollisionMatrix.prototype.addAll=function(e,t,n){if(t>0&&n>0&&t<this.xc&&n<this.yc){var r=this.matrix[t][n];while(r.next!=null){r=r.next;e.next=new DropItem(r.drop);e=e.next}}return e};CollisionMatrix.prototype.remove=function(e){this.matrix[e.gmx][e.gmy].remove(e)};DropItem.prototype.add=function(e){var t=this;while(t.next!=null){t=t.next}t.next=new DropItem(e)};DropItem.prototype.remove=function(e){var t=this;var n=null;while(t.next!=null){n=t;t=t.next;if(t.drop.gid===e.gid){n.next=t.next}}}